<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Client Timeline Viz</title>
        <script type="text/javascript" src="d3.v3.js"></script>
		<link rel="stylesheet" type="text/css" href="stylesheet.css">
    </head>
    <body>
        <div>
            <p id="title">royall<em>&</em>company</p>
        </div>
        <div>
            <p id="barChartTitle">Royall Partnerships by Origination Year</p>
        </div>
        <div id="barChart"></div>
        <div id="pieChart"></div>     
        <div id="pieChartCaption"></div>
        
        
        
        
        
        <script type="text/javascript">
		var dataset;
		var w = 100;
		var h = 200;
		var barBuffer = 2;
//Create Schools dataset
		d3.csv("schools.csv", function(d){
			dataset = d;
			//alert("Data Has Been Loaded!");
			load();
			});
		function load(){
//All d3.js actions happen below within load() *after csv import*

//Nest to transform dataset object
		var years=d3.nest()
			.key(function(d){ return d.year;})
			.sortKeys(d3.ascending)
			.entries(dataset);

            


//define the ToolTips
		var bdiv = d3.select("body").append("div")
			.attr("class","barTip")
			.style("opacity",0);
        var cdiv = d3.select("body").append("div")
			.attr("class","cirTip")
			.style("opacity",0);
            
        
//build barChart
		svg = d3.select("#barChart").append("svg")
			.attr("height",h)
			.attr("width",w + "%");            

		var barchart = svg.selectAll("rect")
			.data(years)
			.enter()
			.append("rect")
			.attr("width",function(){
				return w / years.length + "%" ;
				})
			.attr("height",function(d){
				return d.values.length*4;
					})
			.attr("x",function(d,i){
				return i* (w/years.length) + "%" ;
					})
			.attr("y",h)
			.attr("fill","none")
            .attr("stroke","black")
            .attr("stroke-width","5px")
            .attr("flex","1")
			.on("mouseover",function(d){
				bdiv.transition()
					.duration(100)
					.style("opacity",.8);
				bdiv.html(d.values.length+" clients acquired in <br/>"+d.key)
					.style("left",(d3.event.pageX)+"px")
					.style("top","17.5%");
				})
			.on("mouseout",function(d){
				bdiv.transition()
					.duration(500)
					.style("opacity",0);
			})
			.transition()
			.duration(1000)
			.ease("elastic")
			.delay(function(d,i){
				return i*50;
				})
			.attr("fill",d3.rgb(42,110,187))
			.attr("y",function(d){
				return (h-d.values.length*4)-10;
					});

		svg.selectAll("text")
			.data(years)
			.enter()
			.append("text")
			.attr("x",function(d,i){
				return i*(w/years.length) + (w/years.length)/2+"%";
				})
			.attr("y",h)
			.attr("text-anchor","middle")
			.attr("font-family","Arial")
			.attr("font-size","xx-small")
			.attr("font-weight","bold")
			.attr("fill","white")
			.text(function(d){
				return d.key;
				});

		var years_running_total = [];
		var running_sum = 0;
		for (var y = 0; y < years.length; y++){
			running_sum = running_sum + years[y].values.length;
			var rt = ({
				"year": years.key,
				"running_sum": running_sum
				});
			years_running_total.push(rt)
			};
			
		var cScale = d3.scale.linear()
			.domain([0,d3.max(years_running_total,function(d){
				return d.running_sum;
				})])
			.range([1,10]);
			
		var yScale = d3.scale.linear()
			.domain([d3.min(years_running_total,function(d){
				return d.running_sum;
				})
				,d3.max(years_running_total,function(d){
				return d.running_sum;
				})])
			.range([h-h/3,h/3]);
		
//add circles to barChart
        svg.selectAll("circle")
			.data(years_running_total)
			.enter()
			.append("circle")
			.attr("cx",0)
			.attr("cy",0)
            .on("mouseover",function(d){
				cdiv.transition()
					.duration(100)
					.style("opacity",.8);
				cdiv.html(d.running_sum+" clients acquired to date")
					.style("left",(d3.event.pageX)+"px")
					.style("top","17.5%");
				})
			.on("mouseout",function(d){
				cdiv.transition()
					.duration(500)
					.style("opacity",0);
			})
			.transition()
			.duration(3000)
			.attr("cx",function(d,i){
				return i*(w/years.length)+(w/years.length)/2 + "%";
				})
			.attr("cy",function(d){
				return yScale(d.running_sum);
				})
			.attr("r",function(d){
				return cScale(d.running_sum);
				})
			.attr("fill",d3.rgb(187,19,62))
			.attr("opacity",0.5);
			
		

        

            

//Create Donut using Pie layout            
        var pie = d3.layout.pie();
        var colors = ["rgb(187,19,62)","rgba(0,0,0,0)"];
        var retention = ({
            "retained": 0,
            "lost": 0
        });
 
       for (var i=0;i<dataset.length;i++){
        if(dataset[i].subtype == "Existing Client"){
            retention.retained++;
        }else{
            retention.lost++;
        }
       }

        var rt = [retention.retained,retention.lost];
                         
console.log(retention);

       var svgpie = d3.select("#pieChart").append("svg")
            .attr("width",w+"%")
            .attr("height",h)
            .attr("id","svgPie")
            .append("g")
            .attr("transform","translate("+w+","+h/2+")");
        var donut = d3.layout.pie()
            .sort(null);
        var arc = d3.svg.arc()
            .innerRadius(50)
            .outerRadius(100);
        var colors = ["rgba(187,19,62,1)","rgba(0,0,0,0)"] ;   
       svgpie.selectAll("path")
            .data(donut(rt))
            .enter()
            .append("path")
            .attr("cx",0)
            .attr("cy",0)
            .attr("r",function(d){
                return d;
                })
            .attr("fill",function(d,i){
                return colors[i];
           })
            .attr("d",arc);
		
		
		
		
		
		
		
		};

		</script>
	</body>
</html>		